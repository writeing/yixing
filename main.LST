C51 COMPILER V9.03   MAIN                                                                  08/06/2015 11:49:22 PAGE 1   


C51 COMPILER V9.03, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\output\main.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE DEBUG OBJECTEXTEND OBJECT(.\output\main.obj)

line level    source

   1          /***********************************
   2          8-5号
   3          因为用arduino电脑经常蓝屏，怀疑的串口的原因，所以放弃arduino，专用stm15w开发，并且传送到git上面，
   4          
   5          
   6          
   7          
   8          ************************************/
   9          #include "main.h"
  10          /*****************************************/
  11          
  12          /*****************************************/
  13          uchar ssid[]={"ih"};
  14          uchar passwd[]={"yixing123456"};
  15          uchar IPAddress[]={"192,168,1,100"};
  16          uint Port=5000;
  17          uchar RemoteIP[4]={0};
  18          char GetCmd[]={"GET / HTTP/1.1\r\nHost: 192.168.1.100\r\nUser-Agent: abc\r\nConnection: close\r\n"};
  19          char PostCmd[]={"POST / HTTP/1.1\r\nHost: 192.168.1.100\r\nUser-Agent: abc\r\nContent-type: text/plain\r\n
             -Content-Length:10\r\n\r\nabcdefghij\r\nConnection: close\r\n"};
  20          char buffer[1024];
  21          
  22          
  23          sbit RST = P2^6;
  24          
  25          unsigned char xdata Rec_Buf[Buf_Max];
  26          unsigned char i = 0;   
  27          void CLR_Buf(void);                                
  28          bit  Hand(unsigned char *a);    
  29          
  30          
  31          
  32          sbit LED1 = P5^0;                   // 定义LED1为P5.1 
  33          sbit LED2 = P5^1;                               // 定义LED2为P5.2
  34          sbit LED3 = P5^2;                               // 定义LED3为P5.3
  35          
  36          /**************************
  37          函数名称：
  38          函数作用：
  39          函数参数：
  40          函数备注：
  41          ***************************/
  42          
  43          /**************************
  44          函数名称：
  45          函数作用：
  46          函数参数：
  47          函数备注：
  48          ***************************/
  49          char isOK()
  50          {
  51   1              int i=0;
  52   1              char OK[]={"ok"};
  53   1              char err[]={"err"};
  54   1              int t=0;
C51 COMPILER V9.03   MAIN                                                                  08/06/2015 11:49:22 PAGE 2   

  55   1              t= strlen(buffer);
  56   1              if(buffer[t-2]=='o'&&buffer[t-1]=='k')
  57   1              {
  58   2                      return 1;
  59   2              }
  60   1              return '0';     
  61   1      }
  62          /**************************
  63          函数名称:sendCmd
  64          函数作用：发送wifi参数
  65          函数参数：cmd
  66          函数备注：
  67          ***************************/
  68          void sendCmd(uint cmd)
  69          {
  70   1              switch(cmd)
  71   1              {
  72   2                      case 1:
  73   2                      WifiSend("AT+CWJAP=\"ih\",\"yixing123456\"");
  74   2                              break;
  75   2                      case 2:
  76   2                      WifiSend("AT+CWMODE=3");
  77   2                      delay(100);
  78   2              //      WifiSend("AT+RST");
  79   2                              break;
  80   2                      case 3:
  81   2                      WifiSend("AT+CWQAP");
  82   2                              break;
  83   2                      case 4:
  84   2                      WifiSend("AT+CIPSTART=\"TCP\",\"192.168.1.100\",5000");
  85   2                              break;
  86   2                      case 5:
  87   2                      WifiSend("AT+CIPSEND");
  88   2                              break;
  89   2                      case 6:
  90   2                      WifiSend("AT+CIPMODE=1");
  91   2                              break;
  92   2                      case 7:
  93   2                      WifiSend("AT+CIPCLOSE");
  94   2                              break;
  95   2                      default :WifiSend("AT+RST"); 
  96   2              }
  97   1      }
  98          /**************************
  99          函数名称:sendDate
 100          函数作用：发送wifi数据
 101          函数参数：cmd
 102          函数备注：
 103          ***************************/
 104          void sendDate(uint cmd)
 105          {
 106   1              switch(cmd)
 107   1              {
 108   2                      case 1:
 109   2                      WifiSend(GetCmd);
 110   2                              break;
 111   2                      case 2:         
 112   2                      WifiSend(PostCmd);
 113   2                              break;
 114   2                      default :WifiSend("AT+RST"); 
 115   2              }
 116   1      }
C51 COMPILER V9.03   MAIN                                                                  08/06/2015 11:49:22 PAGE 3   

 117          /**************************
 118          函数名称：delay()
 119          函数作用：延时
 120          函数参数：延时时间，单位 秒
 121          函数备注：
 122          ***************************/
 123          void delay(uint time)
 124          {
 125   1              uint y=0;
 126   1              while(time--)
 127   1              {
 128   2                      y=250;
 129   2                      while(y--);
 130   2              }
 131   1      }
 132          void Init()
 133          {               
 134   1              RST = 1;                                      // ESP8266复位功能脚，拉低会将ESP8266复位
 135   1              UartInit();                                                                   // 初始化串口
 136   1              ES = 1;                                       // 串口1中断打开
 137   1              IE2 = 0x01;                                   // 串口2中断打开
 138   1              EA = 1;                                       // 总中断打开
 139   1              DelayMS(1000);                                                                    // 延时一段时间，让ESP8266启动
 140   1      
 141   1              U1SendString(Rec_Buf);                        // 将ESP8266启动信息通过串口1打印出       
 142   1              U1SendString("Welcome to LSE STUDIO,\r\n");     
 143   1              CLR_Buf();                                              //清除缓存内容  
 144   1              while(!Hand("OK"))                            //判断是否握手成功,如果不成功延时一会,再发送AT握手指令
 145   1              {       
 146   2                      CLR_Buf();      
 147   2                      WifiSendString("AT");                         //发送联机指令 
 148   2                      DelayMS(500);
 149   2                      U1SendString(Rec_Buf);
 150   2              }
 151   1              CLR_Buf();                                    //清除缓存内容
 152   1              U1SendString("OK,Succeed Establish connection with ESP8266\r\n");               
 153   1              LED1 = 0;
 154   1      
 155   1              
 156   1              while(!(Hand("OK")))        //判断是否设置成功，如不成功，延时后再次发送
 157   1              {       
 158   2                      CLR_Buf();      
 159   2                      sendCmd(CWMODE);                         //发送设置ESP8266工作模式指令  
 160   2                      DelayMS(500);
 161   2                      U1SendString(Rec_Buf);
 162   2                      if(Hand("no change"))           
 163   2                      {
 164   3                              U1SendString(Rec_Buf);
 165   3                              break;
 166   3                      }               
 167   2              }
 168   1              CLR_Buf();                 
 169   1              U1SendString("OK,ESP8266 has been set as Station Mode\r\n");    
 170   1      
 171   1              
 172   1              while(!Hand("OK"))                                                                                              //判断是否连接WiFi路由器，如不成功，延时后再次发送
 173   1              {       
 174   2                      CLR_Buf();      
 175   2                      sendCmd(CWJAP);         
 176   2                      DelayMS(2000);
 177   2                      if(Hand("no change"))           //如果IP地址已经存在
 178   2                      {
C51 COMPILER V9.03   MAIN                                                                  08/06/2015 11:49:22 PAGE 4   

 179   3                              U1SendString(Rec_Buf);
 180   3                              break;
 181   3                      }
 182   2                      U1SendString(Rec_Buf);          
 183   2              }
 184   1              LED2 = 0;
 185   1              CLR_Buf();              
 186   1              U1SendString("OK,Succeed establish connection with WiFi AP\r\n");                       
 187   1              while(!Hand("Linked"))                        //判断是否连接TCP sever，如不成功，延时后再次发送
 188   1              {
 189   2                      CLR_Buf();
 190   2                      sendCmd(CIPSTART);  
 191   2                      DelayMS(3000);
 192   2                      U1SendString(Rec_Buf);
 193   2              }
 194   1              CLR_Buf();                
 195   1              U1SendString("OK,Succeed establish connection with TCP sever\r\n");                     
 196   1              LED1 = 1;
 197   1              LED2 = 1;       
 198   1              sendCmd(CIPMODE); //数据发送指令 
 199   1              DelayMS(1000);  
 200   1              while(!Hand("SEND OK"))                                                                         //判断是否发送数据成功，如不成功，延时后再次发送
 201   1              {
 202   2                      CLR_Buf();              
 203   2                      sendCmd(CIPSEND); //数据内容    
 204   2                      DelayMS(500);
 205   2                      sendDate(1); //数据内容 
 206   2                      DelayMS(500);
 207   2                      U1SendString(Rec_Buf);
 208   2              }
 209   1              CLR_Buf();                
 210   1              U1SendString("Congratulations, You can send commands through TCP sever now\r\n");                                                       
 211   1      }
 212          int main()
 213          {
 214   1              int i=0;
 215   1              Init();
 216   1              init_port();
 217   1              U1SendString("tooo\n");
 218   1              while(1)
 219   1              {
 220   2                      U1SendString("wangdaye\r\n");   
 221   2                      delay(1000);
 222   2              }
 223   1              return 0;
 224   1      }
 225          
 226          
 227          bit Hand(unsigned char *a)
 228          { 
 229   1          if(strstr(Rec_Buf,a)!=NULL)
 230   1                  return 1;
 231   1              else
 232   1                      return 0;
 233   1      }
 234          
 235          void CLR_Buf(void)
 236          {
 237   1              unsigned char k;
 238   1          for(k=0;k<Buf_Max;k++)    
 239   1          {
 240   2                      Rec_Buf[k] = 0;
C51 COMPILER V9.03   MAIN                                                                  08/06/2015 11:49:22 PAGE 5   

 241   2              }
 242   1          i = 0;                    
 243   1      }
 244          
 245          void Uart1() interrupt 4 using 1
 246          {
 247   1              ES = 0;
 248   1              if (RI)
 249   1          {
 250   2            RI = 0;                 //清除RI位
 251   2                Rec_Buf[i] = SBUF; 
 252   2                i++;               
 253   2                if(i>Buf_Max)          
 254   2                {
 255   3                      i = 0;
 256   3                } 
 257   2          }
 258   1          if (TI)
 259   1          {
 260   2              TI = 0;                 //清除TI位
 261   2      
 262   2          }
 263   1              ES =  1;
 264   1      }
 265          
 266          
 267          
 268          void Uart2() interrupt 8
 269          {
 270   1              IE2 = 0x00;
 271   1          if (S2CON & S2RI)
 272   1          {
 273   2              S2CON &= ~S2RI;         
 274   2                      Rec_Buf[i] = S2BUF; 
 275   2                      i++;               
 276   2                      if(i>Buf_Max)          
 277   2                      {
 278   3                              i = 0;
 279   3                      }     
 280   2          }
 281   1          if (S2CON & S2TI)
 282   1          {
 283   2              S2CON &= ~S2TI;            
 284   2          }
 285   1              IE2 = 0x01;
 286   1      }
 287          void init_port()
 288          {
 289   1      P0M0 = 0x00;
 290   1      P0M1 = 0x00;
 291   1      P1M0 = 0x00;
 292   1      P1M1 = 0x00;
 293   1      P2M0 = 0x00;
 294   1      P2M1 = 0x00;
 295   1      P3M0 = 0x00;
 296   1      P3M1 = 0x00;
 297   1      P4M0 = 0x00;
 298   1      P4M1 = 0x00;
 299   1      P5M0 = 0x00;
 300   1      P5M1 = 0x00;
 301   1      P6M0 = 0x00;
 302   1      P6M1 = 0x00;
C51 COMPILER V9.03   MAIN                                                                  08/06/2015 11:49:22 PAGE 6   

 303   1      P7M0 = 0x00;
 304   1      P7M1 = 0x00;
 305   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    902    ----
   CONSTANT SIZE    =    460    ----
   XDATA SIZE       =   1519      14
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
