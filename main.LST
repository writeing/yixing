C51 COMPILER V9.03   MAIN                                                                  08/05/2015 18:08:20 PAGE 1   


C51 COMPILER V9.03, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\output\main.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE DEBUG OBJECTEXTEND OBJECT(.\output\main.obj)

line level    source

   1          /***********************************
   2          8-5号
   3          因为用arduino电脑经常蓝屏，怀疑的串口的原因，所以放弃arduino，专用stm15w开发，并且传送到git上面，
   4          
   5          
   6          
   7          
   8          ************************************/
   9          #include "main.h"
  10          /*****************************************/
  11          
  12          /*****************************************/
  13          uchar ssid[]={"ih"};
  14          uchar passwd[]={"yixing123456"};
  15          uchar IPAddress[]={"192,168,1,104"};
  16          uint Port=5000;
  17          uchar RemoteIP[4]={0};
  18          char GetCmd[]={"GET / HTTP/1.1\r\nHost: 192.168.1.104\r\nUser-Agent: abc\r\nConnection: close\r\n"};
  19          char PostCmd[]={"POST / HTTP/1.1\r\nHost: 192.168.1.104\r\nUser-Agent: abc\r\nContent-type: text/plain\r\n
             -Content-Length:10\r\n\r\nabcdefghij\r\nConnection: close\r\n"};
  20          char buffer[1024];
  21          
  22          
  23          sbit RST = P2^6;
  24          
  25          unsigned char xdata Rec_Buf[Buf_Max];
  26          unsigned char i = 0;   
  27          void CLR_Buf(void);                                
  28          bit  Hand(unsigned char *a);    
  29          
  30          
  31          
  32          sbit LED1 = P5^0;                   // 定义LED1为P5.1 
  33          sbit LED2 = P5^1;                               // 定义LED2为P5.2
  34          sbit LED3 = P5^2;                               // 定义LED3为P5.3
  35          
  36          /**************************
  37          函数名称：
  38          函数作用：
  39          函数参数：
  40          函数备注：
  41          ***************************/
  42          
  43          /**************************
  44          函数名称：
  45          函数作用：
  46          函数参数：
  47          函数备注：
  48          ***************************/
  49          char isOK()
  50          {
  51   1              int i=0;
  52   1              char OK[]={"ok"};
  53   1              char err[]={"err"};
  54   1              int t=0;
C51 COMPILER V9.03   MAIN                                                                  08/05/2015 18:08:20 PAGE 2   

  55   1              t= strlen(buffer);
  56   1              if(buffer[t-2]=='o'&&buffer[t-1]=='k')
  57   1              {
  58   2                      return 1;
  59   2              }
  60   1              return '0';     
  61   1      }
  62          /**************************
  63          函数名称:sendCmd
  64          函数作用：发送wifi参数
  65          函数参数：cmd
  66          函数备注：
  67          ***************************/
  68          void sendCmd(uint cmd)
  69          {
  70   1              switch(cmd)
  71   1              {
  72   2                      case 1:
  73   2                      WifiSend("AT+CWJAP=\"ih\",\"yixing123456\"");
  74   2                              break;
  75   2                      case 2:
  76   2                      WifiSend("AT+CWMODE=3");
  77   2                      WifiSend("AT+RST");
  78   2                              break;
  79   2                      case 3:
  80   2                      WifiSend("AT+CWQAP");
  81   2                              break;
  82   2                      case 4:
  83   2                      WifiSend("AT+CIPSTART=\"TCP\",\"192.168.1.104\",5000");
  84   2                              break;
  85   2                      case 5:
  86   2                      WifiSend("AT+CIPSEND");
  87   2                              break;
  88   2                      case 6:
  89   2                      WifiSend("AT+CIPMODE=1");
  90   2                              break;
  91   2                      case 7:
  92   2                      WifiSend("AT+CIPCLOSE");
  93   2                              break;
  94   2                      default :WifiSend("AT+RST"); 
  95   2              }
  96   1      }
  97          /**************************
  98          函数名称:sendDate
  99          函数作用：发送wifi数据
 100          函数参数：cmd
 101          函数备注：
 102          ***************************/
 103          void sendDate(uint cmd)
 104          {
 105   1              switch(cmd)
 106   1              {
 107   2                      case 1:
 108   2                      WifiSend(GetCmd);
 109   2                              break;
 110   2                      case 2:         
 111   2                      WifiSend(PostCmd);
 112   2                              break;
 113   2                      default :WifiSend("AT+RST"); 
 114   2              }
 115   1      }
 116          /**************************
C51 COMPILER V9.03   MAIN                                                                  08/05/2015 18:08:20 PAGE 3   

 117          函数名称：delay()
 118          函数作用：延时
 119          函数参数：延时时间，单位 秒
 120          函数备注：
 121          ***************************/
 122          void delay(uint time)
 123          {
 124   1              uint y=0;
 125   1              while(time--)
 126   1              {
 127   2                      y=250;
 128   2                      while(y--);
 129   2              }
 130   1      }
 131          void Init()
 132          {               
 133   1              RST = 1;                                      // ESP8266复位功能脚，拉低会将ESP8266复位
 134   1              UartInit();                                                                   // 初始化串口
 135   1              ES = 1;                                       // 串口1中断打开
 136   1              IE2 = 0x01;                                   // 串口2中断打开
 137   1              EA = 1;                                       // 总中断打开
 138   1              DelayMS(1000);                                                                    // 延时一段时间，让ESP8266启动
 139   1      
 140   1              U1SendString("123456789");                        // 将ESP8266启动信息通过串口1打印出           
 141   1              U1SendString("Welcome to LSE STUDIO,\r\n");     
 142   1              U1SendString("aaa");
 143   1              while(!Hand("OK"))                            //判断是否握手成功,如果不成功延时一会,再发送AT握手指令
 144   1              {
 145   2                      CLR_Buf();                                              //清除缓存内容  
 146   2                      WifiSendString("AT");                         //发送联机指令 
 147   2                      DelayMS(500);
 148   2                      U1SendString("AT\n");
 149   2              }
 150   1              CLR_Buf();                                    //清除缓存内容
 151   1              U1SendString("OK,Succeed Establish connection with ESP8266\r\n");               
 152   1              LED1 = 0;
 153   1      
 154   1              
 155   1              while(!(Hand("OK")))        //判断是否设置成功，如不成功，延时后再次发送
 156   1              {               
 157   2                      sendCmd(CWMODE);                         //发送设置ESP8266工作模式指令  
 158   2                      DelayMS(500);           
 159   2              }
 160   1              CLR_Buf();                 
 161   1              U1SendString("OK,ESP8266 has been set as Station Mode\r\n");    
 162   1      
 163   1              
 164   1              while(!Hand("OK")|Hand("no change"))                                                                                                    //判断是否连接WiFi路由器，如不成功，延时后再次发送
 165   1              {               
 166   2                      sendCmd(CWJAP);         
 167   2                      DelayMS(2000);          
 168   2              }
 169   1              LED2 = 0;
 170   1              CLR_Buf();              
 171   1              U1SendString("OK,Succeed establish connection with WiFi AP\r\n");                       
 172   1              while(!Hand("Linked"))                        //判断是否连接TCP sever，如不成功，延时后再次发送
 173   1              {
 174   2                      sendCmd(CIPSTART);  
 175   2                      DelayMS(3000);
 176   2                      
 177   2              }
 178   1              CLR_Buf();                
C51 COMPILER V9.03   MAIN                                                                  08/05/2015 18:08:20 PAGE 4   

 179   1              U1SendString("OK,Succeed establish connection with TCP sever\r\n");                     
 180   1              LED1 = 1;
 181   1              LED2 = 1;               
 182   1              while(!Hand("SEND OK"))                                                                         //判断是否发送数据成功，如不成功，延时后再次发送
 183   1              {
 184   2      
 185   2                      sendCmd(CIPMODE); //数据发送指令 
 186   2                      DelayMS(100);           
 187   2                      sendCmd(CIPSEND); //数据内容    
 188   2                      DelayMS(500);
 189   2                      sendDate(1); //数据内容 
 190   2                      DelayMS(500);
 191   2              }
 192   1              CLR_Buf();                
 193   1              U1SendString("Congratulations, You can send commands through TCP sever now\r\n");                                                       
 194   1      }
 195          int main()
 196          {
 197   1              int i=0;
 198   1              U1SendString("wocaonima\n");
 199   1              Init();
 200   1              U1SendString("tooo\n");
 201   1              while(1)
 202   1              {
 203   2                      U1SendString("wangdaye\r\n");   
 204   2              }
 205   1              return 0;
 206   1      }
 207          
 208          
 209          bit Hand(unsigned char *a)
 210          { 
 211   1          if(strstr(Rec_Buf,a)!=NULL)
 212   1                  return 1;
 213   1              else
 214   1                      return 0;
 215   1      }
 216          
 217          void CLR_Buf(void)
 218          {
 219   1              unsigned char k;
 220   1          for(k=0;k<Buf_Max;k++)    
 221   1          {
 222   2                      Rec_Buf[k] = 0;
 223   2              }
 224   1          i = 0;                    
 225   1      }
 226          
 227          void Uart1() interrupt 4 using 1
 228          {
 229   1              ES = 0;
 230   1              if (RI)
 231   1          {
 232   2            RI = 0;                 //清除RI位
 233   2                Rec_Buf[i] = SBUF; 
 234   2                i++;               
 235   2                if(i>Buf_Max)          
 236   2                {
 237   3                      i = 0;
 238   3                } 
 239   2          }
 240   1          if (TI)
C51 COMPILER V9.03   MAIN                                                                  08/05/2015 18:08:20 PAGE 5   

 241   1          {
 242   2              TI = 0;                 //清除TI位
 243   2      
 244   2          }
 245   1              ES =  1;
 246   1      }
 247          
 248          
 249          
 250          void Uart2() interrupt 8 using 1
 251          {
 252   1              IE2 = 0x00;     
 253   1          if (S2CON & S2RI)
 254   1          {
 255   2              S2CON &= ~S2RI;         
 256   2                      Rec_Buf[i] = S2BUF; 
 257   2                      i++;               
 258   2                      if(i>Buf_Max)          
 259   2                      {
 260   3                              i = 0;
 261   3                      }     
 262   2          }
 263   1          if (S2CON & S2TI)
 264   1          {
 265   2              S2CON &= ~S2TI;            
 266   2          }
 267   1              IE2 = 0x01;             
 268   1      }
 269          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    802    ----
   CONSTANT SIZE    =    489    ----
   XDATA SIZE       =   1519      14
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
